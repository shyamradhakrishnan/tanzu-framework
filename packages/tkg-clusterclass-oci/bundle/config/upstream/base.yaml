#@ load("@ytt:overlay", "overlay")
#@ load("@ytt:yaml", "yaml")
#@ load("@ytt:data", "data")

apiVersion: cluster.x-k8s.io/v1beta1
kind: ClusterClass
metadata:
  name: tkg-oci-default
  namespace: #@ data.values.NAMESPACE
spec:
  controlPlane:
    ref:
      apiVersion: controlplane.cluster.x-k8s.io/v1beta1
      kind: KubeadmControlPlaneTemplate
      name: tkg-kcp
    machineInfrastructure:
      ref:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: OCIMachineTemplate
        name: tkg-controlplane-oci-template
  workers:
    machineDeployments:
      - class: tkg-worker
        template:
          bootstrap:
            ref:
              apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
              kind: KubeadmConfigTemplate
              name: tkg-oci-bootstrap-template
          infrastructure:
            ref:
              apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
              kind: OCIMachineTemplate
              name: tkg-oci-worker-template
  infrastructure:
    ref:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: OCIClusterTemplate
      name: oci-cluster-template
  variables:
    - name: ssh_authorized_keys
      required: false
      schema:
        openAPIV3Schema:
          type: string
          default: default
    - name: compartmentId
      required: true
      schema:
        openAPIV3Schema:
          type: string
    - name: imageId
      required: true
      schema:
        openAPIV3Schema:
          type: string
    - name: shape
      required: false
      schema:
        openAPIV3Schema:
          type: string
          default: VM.Standard.E4.Flex
    - name: ocpus
      required: false
      schema:
        openAPIV3Schema:
          type: string
          default: "1"
    - name: isPvEncryptionInTransitEnabled
      required: false
      schema:
        openAPIV3Schema:
          type: boolean
          default: true
  patches:
    - name: compartmentId
      definitions:
        - selector:
            apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
            kind: OCIClusterTemplate
            matchResources:
              infrastructureCluster: true
          jsonPatches:
            - op: add
              path: "/spec/template/spec/compartmentId"
              valueFrom:
                variable: compartmentId
    - name: sshAuthorizedKeys
      definitions:
        - selector:
            apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
            kind: OCIMachineTemplate
            matchResources:
              controlPlane: true
              machineDeploymentClass:
                names:
                  - tkg-worker
          jsonPatches:
            - op: add
              path: "/spec/template/spec/metadata/ssh_authorized_keys"
              valueFrom:
                variable: ssh_authorized_keys
    - name: shape
      definitions:
        - selector:
            apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
            kind: OCIMachineTemplate
            matchResources:
              controlPlane: true
              machineDeploymentClass:
                names:
                  - tkg-worker
          jsonPatches:
            - op: replace
              path: "/spec/template/spec/shape"
              valueFrom:
                variable: shape
    - name: imageId
      definitions:
        - selector:
            apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
            kind: OCIMachineTemplate
            matchResources:
              controlPlane: true
              machineDeploymentClass:
                names:
                  - tkg-worker
          jsonPatches:
            - op: add
              path: "/spec/template/spec/imageId"
              valueFrom:
                variable: imageId
    - name: isPvEncryptionInTransitEnabled
      definitions:
        - selector:
            apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
            kind: OCIMachineTemplate
            matchResources:
              controlPlane: true
              machineDeploymentClass:
                names:
                  - tkg-worker
          jsonPatches:
            - op: add
              path: "/spec/template/spec/isPvEncryptionInTransitEnabled"
              valueFrom:
                variable: isPvEncryptionInTransitEnabled
    - name: ocpus
      definitions:
        - selector:
            apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
            kind: OCIMachineTemplate
            matchResources:
              controlPlane: true
              machineDeploymentClass:
                names:
                  - tkg-worker
          jsonPatches:
            - op: add
              path: /spec/template/spec/shapeConfig/ocpus
              valueFrom:
                variable: ocpus
    - name: apiServerBindPort
      enabledIf: '{{ not (empty .apiServerPort) }}'
      definitions:
        - selector:
            apiVersion: controlplane.cluster.x-k8s.io/v1beta1
            kind: KubeadmControlPlaneTemplate
            matchResources:
              controlPlane: true
          jsonPatches:
            - op: add
              path: /spec/template/spec/kubeadmConfigSpec/initConfiguration/localAPIEndpoint
              valueFrom:
                template: |
                  advertiseAddress: '0.0.0.0'
                  bindPort: {{ .apiServerPort }}
            - op: add
              path: /spec/template/spec/kubeadmConfigSpec/joinConfiguration/controlPlane
              valueFrom:
                template: |
                  localAPIEndpoint:
                    advertiseAddress: '0.0.0.0'
                    bindPort: {{ .apiServerPort }}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: OCIClusterTemplate
metadata:
  name: oci-cluster-template
  namespace: #@ data.values.NAMESPACE
spec:
  template:
    spec:
      networkSpec:
        vcn:
          cidr: "10.0.0.0/16"
          subnets:
            - cidr: 10.0.0.8/29
              name: control-plane-endpoint
              role: control-plane-endpoint
              type: public
            - cidr: 10.0.0.0/29
              name: control-plane
              role: control-plane
              type: private
            - cidr: 10.0.0.32/27
              name: service-lb
              role: service-lb
              type: public
            - cidr: 10.0.64.0/20
              name: worker
              role: worker
              type: private
          networkSecurityGroups:
            - egressRules:
                - egressRule:
                    description: Control Plane Nodes access to Internet
                    destination: 0.0.0.0/0
                    destinationType: CIDR_BLOCK
                    isStateless: false
                    protocol: all
              ingressRules:
                - ingressRule:
                    description: Kubernetes API endpoint to Kubernetes control plane node(apiserver
                      port) communication
                    isStateless: false
                    protocol: "6"
                    source: 10.0.0.8/29
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 6443
                        min: 6443
                - ingressRule:
                    description: Control plane node to control plane node(apiserver port)
                      communication
                    isStateless: false
                    protocol: "6"
                    source: 10.0.0.0/29
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 6443
                        min: 6443
                - ingressRule:
                    description: Worker Node to Kubernetes control plane node(apiserver port)
                      communication
                    isStateless: false
                    protocol: "6"
                    source: 10.0.64.0/20
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 6443
                        min: 6443
                - ingressRule:
                    description: etcd client communication
                    isStateless: false
                    protocol: "6"
                    source: 10.0.0.0/29
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 2379
                        min: 2379
                - ingressRule:
                    description: etcd peer
                    isStateless: false
                    protocol: "6"
                    source: 10.0.0.0/29
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 2380
                        min: 2380
                - ingressRule:
                    description: Antrea Service
                    isStateless: false
                    protocol: "6"
                    source: 10.0.0.0/29
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 10349
                        min: 10349
                - ingressRule:
                    description: Antrea Service
                    isStateless: false
                    protocol: "6"
                    source: 10.0.64.0/20
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 10349
                        min: 10349
                - ingressRule:
                    description: Geneve Service
                    isStateless: false
                    protocol: "17"
                    source: 10.0.0.0/29
                    sourceType: CIDR_BLOCK
                    udpOptions:
                      destinationPortRange:
                        max: 6081
                        min: 6081
                - ingressRule:
                    description: Geneve Service
                    isStateless: false
                    protocol: "17"
                    source: 10.0.64.0/20
                    sourceType: CIDR_BLOCK
                    udpOptions:
                      destinationPortRange:
                        max: 6081
                        min: 6081
                - ingressRule:
                    description: Path discovery
                    icmpOptions:
                      code: 3
                      type: 3
                    isStateless: false
                    protocol: "1"
                    source: 10.0.0.0/16
                    sourceType: CIDR_BLOCK
                - ingressRule:
                    description: Inbound SSH traffic to control plane nodes
                    isStateless: false
                    protocol: "6"
                    source: 0.0.0.0/0
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 22
                        min: 22
                - ingressRule:
                    description: Control Plane to Control Plane Kubelet Communication
                    isStateless: false
                    protocol: "6"
                    source: 10.0.0.0/29
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 10250
                        min: 10250
              name: control-plane
              role: control-plane
            - egressRules:
                - egressRule:
                    description: Worker Nodes access to Internet
                    destination: 0.0.0.0/0
                    destinationType: CIDR_BLOCK
                    isStateless: false
                    protocol: all
              ingressRules:
                - ingressRule:
                    description: Inbound SSH traffic to worker nodes
                    isStateless: false
                    protocol: "6"
                    source: 0.0.0.0/0
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 22
                        min: 22
                - ingressRule:
                    description: Path discovery
                    icmpOptions:
                      code: 3
                      type: 3
                    isStateless: false
                    protocol: "1"
                    source: 10.0.0.0/16
                    sourceType: CIDR_BLOCK
                - ingressRule:
                    description: Control plane nodes to worker node Kubelet Communication
                    isStateless: false
                    protocol: "6"
                    source: 10.0.0.0/29
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 10250
                        min: 10250
                - ingressRule:
                    description: Worker nodes to worker node Kubelet Communication
                    isStateless: false
                    protocol: "6"
                    source: 10.0.64.0/20
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 10250
                        min: 10250
                - ingressRule:
                    description: Geneve Service
                    isStateless: false
                    protocol: "17"
                    source: 10.0.0.0/29
                    sourceType: CIDR_BLOCK
                    udpOptions:
                      destinationPortRange:
                        max: 6081
                        min: 6081
                - ingressRule:
                    description: Geneve Service
                    isStateless: false
                    protocol: "17"
                    source: 10.0.64.0/20
                    sourceType: CIDR_BLOCK
                    udpOptions:
                      destinationPortRange:
                        max: 6081
                        min: 6081
                - ingressRule:
                    description: Worker node to default NodePort ingress communication
                    isStateless: false
                    protocol: "6"
                    source: 10.0.64.0/20
                    sourceType: CIDR_BLOCK
                    tcpOptions:
                      destinationPortRange:
                        max: 32767
                        min: 30000
              name: worker
              role: worker
---
kind: KubeadmControlPlaneTemplate
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
metadata:
  name: tkg-kcp
  namespace: #@ data.values.NAMESPACE
spec:
  template:
    spec:
      kubeadmConfigSpec:
        clusterConfiguration:
          apiServer:
            certSANs: [ localhost, 127.0.0.1 ]
          dns: { }
          etcd: { }
          networking: { }
          scheduler: { }
        initConfiguration:
          nodeRegistration:
            criSocket: /var/run/containerd/containerd.sock
            kubeletExtraArgs:
              cloud-provider: external
              provider-id: oci://{{ ds["id"] }}
        joinConfiguration:
          discovery: { }
          nodeRegistration:
            criSocket: /var/run/containerd/containerd.sock
            kubeletExtraArgs:
              cloud-provider: external
              provider-id: oci://{{ ds["id"] }}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: OCIMachineTemplate
metadata:
  name: tkg-controlplane-oci-template
  namespace: #@ data.values.NAMESPACE
spec:
  template:
    spec:
      # will be replaced by shape variable defined above
      shape: VM.Standard.E4.Flex
      metadata: {}
      shapeConfig: {}

---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: OCIMachineTemplate
metadata:
  name: tkg-oci-worker-template
  namespace: #@ data.values.NAMESPACE
spec:
  template:
    spec:
      # will be replaced by shape variable defined above
      shape: VM.Standard.E4.Flex
      metadata: {}
      shapeConfig: {}
---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: tkg-oci-bootstrap-template
  namespace: #@ data.values.NAMESPACE
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration:
          kubeletExtraArgs:
            cloud-provider: external
            provider-id: oci://{{ ds["id"] }}
